# Программное обеспечение для работы лазерного гравировального станка
## Описание платы
### Питание
На плату подается постоянное напряжение 12 В, на контакты соединителя X1. Стабилизаторы на плате понижают напряжение до 5 В.
### Органы управления
- 6 кнопок, подключенных к портам А0-А5 Arduino Nano:
    - A0 - уменьшить мощность лазера (L-);
    - A1 - увеличить мощность лазера (L+);
    - A2 - сбросить мощность лазера (L Reset);
    - A3 - уменьшить заданную температуру (T-);
    - A4 - увеличить заданную температуру (T+);
    - A5 - выбор стиля (Pattern).
- Датчик температуры на базе микросхемы [MAX6675ISA+](https://www.chipdip.ru/product/max6675isa-2), внешняя термопара подключается к соединителю X2. Управляется выводами D6 (CS), D7 (SCK), D9 (SO).
- Внешний сигнал 24В, подключен к соединителю X6. Поступает на вывод D2 через оптопару D5.
### Объекты управления
- Лазер
Подключен к соединителю X3. Управляется выводом D3
- Нагреватель
Подключен к соединителю X5. Управляется выводом D5
- Пневмо
Подключен к соединителю X4. Управляется выводом D4
- [Дисплей SH1106](https://www.chipdip.ru/product/1.3inch-oled-b)
задействует выводы D10 (CS), D8 (DC), D11 (DIN/MOSI), D13 (CLK), RST (RES??)
## Описание ПО
### Инициализация  
Инициализируются таймеры, конфигурируются входы-выходы, настраиваются подтяжки и кнопки.  
Показывается заставка на экране.  
Настраивается частота ШИМ.  
Инициализируется глобальная переменная systemData с состоянием системы  
Разрешаются прерывания  
### Основной цикл
Читается температура с датчика, в случае ошибки устанавливается код и отключается нагреватель.  
Если работаем с нагревателем (переменная screenstate=1), проверяем, находится ли температура в заданном интервале с учетом гистерезиса и включаем/выключаем нагреватель.  
Если пунктир не задан, то patternDutyPercent = 100, выводим ШИМ заданной мощности (laserBeamDutyPercent, 0..100) на лазер.  
Если подан сигнал 24В - надо запустить таймер задержки. Если таймер сработал - включить пневмо.  
Если сигнала нет - остановить таймер и отключить пневмо.  
#### Обработка кнопок:
- Кнопки L-, L+, T-, T+
Если удерживать кнопку, запускается таймер при срабатывании которого происходит изменение регулируемой величины  
Если нажать и отпустить - однократное изменение  
- Кнопка L Reset
Настройки лазера по умолчанию
- Кнопка Pattern
Переключить паттерн лазера. Если требуется пунктир, включаем прерывания, если не требуется - выключаем. При обработке прерываний переключаем период таймера в зависимости от требуемого пунктира и состояние лазера - работает/нет.  
Если зажаты кнопки T+ и T- происходит включение/выключение нагревателя и изменение картинки на экране.  

Информация обновляется на экране раз в цикл.

## Функции
showSplashscreen() - рисует рамку на весь экран, выводит надпись burn and emboss (координаты левого нижнего угла 1-й буквы), закращивает область снизу и выводит версию   
pinConfig()  - настройка входов-выходов  
displayClear() - очистка экрана (зажигает все пиксели)  
displayShowData(systemData_t& \_systemData) - выводит на экран информацию о состоянии системы:  
- зажигает пиксели до 39 строки
- первой строкой выводится мощность (в %, с выравниванием)
- далее паттерн - пунктир или цельная линия
- если есть ошибка датчика - сообщение об ошибке, если нет - состояние нагревателя, температуру нагревателя и температуру уставки  
displayShowDataNoHeater(systemData_t& \_systemData) - выводим мощность и рисуем паттерн  
byte spiread() - функция чтения 8 бит по SPI  
uint16_t readMAX() - функция чтения данных с [MAX6675ISA+](https://www.chipdip.ru/product/max6675isa-2)

